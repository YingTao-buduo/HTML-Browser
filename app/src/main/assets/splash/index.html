<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name=”viewport” content=”width=device-width,initial-scale=1″/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <link href="css/large_screen_show.css" rel="stylesheet">
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <!-- 引入Vue.js框架 -->
    <script src="js/vue.js"></script>
    <title>激光枪大屏幕显示</title>
</head>

<body>
<!--总体布局-->
<div id="match_whole_info" class="all">
    <!--背景区域-->
    <div class="background">
        <!--标题区域-->
        <div class="title">
            <!--项目LOGO-->
            <img class="projectLogo" src="images/Shooting_Icon.png">
            <!--标题右区域-->
            <div class="title_right">
                <!--标题右上区域-->
                <div class="title_right_top">
                    <!--赛事名称-->
                    <div class="matchName">{{match_name}}</div>
                    <!--标题右上右区域-->
                    <div class="title_right_top_right">
                        <!--承办LOGO-->
                        <img class="undertakeLogo" src="images/company.png">
                    </div>
                </div>
                <!--项目内容-->
                <table class="projectDetail">
                    <tr>
                        <!--赛事类型-->
                        <td>{{match_type_string}}</td>
                        <!--赛事阶段-->
                        <td>{{match_stage}}</td>
                        <!--赛事进程-->
                        <td>{{match_process}}</td>
                        <!--赛事场馆-->
                        <td>{{venue_name}}</td>
                    </tr>
                </table>
            </div>
        </div>
        <!--数据区域-->
        <div class="data">
            <table class="shootingData">
                <thead>
                <tr>
                    <th>排名</th>
                    <th>靶道</th>
                    <th>选手</th>
                    <th>团队</th>
                    <th>1-10</th>
                    <th>11</th>
                    <th>12</th>
                    <th>13</th>
                    <th>14</th>
                    <th>15</th>
                    <th>16</th>
                    <th>17</th>
                    <th>18</th>
                    <th>19</th>
                    <th>20</th>
                    <th>21</th>
                    <th>22</th>
                    <th>23</th>
                    <th>24</th>
                    <th>总成绩</th>
                    <th>环差</th>
                </tr>
                </thead>
                <tbody v-if="current_group_target_sum != 0">
                <tr v-for="(item, index) in current_group_target_sum" :item="item" :key="index" :current_group_target_sum="current_group_target_sum"
                    :style="{'background': allLinesShootData[index].unitIsFinish == false ? conduct_color : over_color,
                     'opacity': allLinesShootData[index].unitIsFinish == false ? 1 : 0.6}">
                    <td>{{allLinesShootData[index].unitRankNum != current_group_target_sum + 1 ? allLinesShootData[index].unitRankNum : ""}}</td>
                    <td>{{allLinesShootData[index].unitTargetNo}}</td>
                    <td>{{allLinesShootData[index].unitPlayerName}}</td>
                    <td>{{allLinesShootData[index].unitPlayerTeam}}</td>
                    <td>{{allLinesShootData[index].unitHeadTenShot != 0 ? allLinesShootData[index].unitHeadTenShot.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 10 ? allLinesShootData[index].unitShootData[10].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 11 ? allLinesShootData[index].unitShootData[11].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 12 ? allLinesShootData[index].unitShootData[12].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 13 ? allLinesShootData[index].unitShootData[13].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 14 ? allLinesShootData[index].unitShootData[14].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 15 ? allLinesShootData[index].unitShootData[15].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 16 ? allLinesShootData[index].unitShootData[16].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 17 ? allLinesShootData[index].unitShootData[17].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 18 ? allLinesShootData[index].unitShootData[18].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 19 ? allLinesShootData[index].unitShootData[19].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 20 ? allLinesShootData[index].unitShootData[20].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 21 ? allLinesShootData[index].unitShootData[21].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 22 ? allLinesShootData[index].unitShootData[22].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitShootData.length > 23 ? allLinesShootData[index].unitShootData[23].unitShootScore.toFixed(1) : ""}}</td>
                    <td>{{allLinesShootData[index].unitTotalScore.toFixed(1)}}</td>
                    <td>{{allLinesShootData[index].unitRingDiff <= 0 ? "" : allLinesShootData[index].unitRingDiff.toFixed(1)}}</td>
                </tr>
                </tbody>
            </table>
        </div>
        <!--靶图区域-->
        <div class="target">
            <ul>
                <li class="target_unit" v-for="(item, index) in current_group_target_sum" :item="item" :key="index">
                    <div class="display_floor">
                        <div class="unit_ring-box">
                            <canvas class="shoot-unit-target" width="475.5px" height="211.6px"></canvas>
                            <canvas class="shoot-unit-point" width="475.5px" height="211.6px"></canvas>
                            <div class="unit_top_frame">
                                <div class="target-text">T {{allLinesTargetData[index].unitTargetNo}}</div>
                            </div>
                            <div class="unit_bottom_frame">
                                <div class="player_name-text">{{allLinesTargetData[index].unitPlayerName}}</div>
                                <div class="current_score-text">{{allLinesTargetData[index].unitTotalScore.toFixed(1)}}</div>
                            </div>
                        </div>
                        <div v-if="allLinesTargetData[index].unitIsFinish" class="target_mask">
                            <div class="target_mask-text" :style="{'color': allLinesTargetData[index].unit_rank_color}">{{allLinesTargetData[index].unitRankNum}}</div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</div>
</body>
<script type="text/javascript">
    /**
     * 获取文件名提取场馆号
     */
    var param = location.href.split('?')[1];//获取参数
    var venueNo = param.split('=')[1];
     //var venueNo = 16;

    var matchWholeInfo = new Vue({
        el: "#match_whole_info",
        data: {
            /**
             * 设置场馆ID和名称
             */
            venue_num: parseInt(venueNo),
            venue_name: "强源体育用品有限公司",

            match_name: "赛事名称",//比赛名称
            match_type: "",//比赛类型
            match_type_string: "激光手枪/激光步枪",//比赛类型字符串
            match_stage: "比赛阶段",//比赛阶段
            match_process: "比赛进程",//比赛进程
            current_group_no: 0,//当前分组
            current_group_target_sum: 0,//当前分组存在靶道数量
            all_groups_sum: 0,//所有分组数量
            allLinesShootData: [],//所有靶道射击数据
            allLinesTargetData: [],//所有靶道靶上数据

            isTestingShoot: false,//是否正在进行试射，默认为false
            isOddShootingFinals: false,//是否正在进行单发射击，默认为false


            //排名颜色
            rank_color_list: {
                1: "#FF0000",
                2: "#FF7D00",
                3: "#FFFF00",
                4: "#00FF00",
                5: "#00FFFF",
                6: "#0000FF",
                7: "#FF00FF",
                8: "#FFC0CB",
                "default": "#CCCCCC"
            },
            conduct_color: "transparent",
            over_color: "#8b8b8b",
        },
        methods: {
            /**
             * 绘制步枪靶
             */
            drawRifleTarget() {
                var canvasRifleArr = document.getElementsByClassName("shoot-unit-target");
                for (var no = 0; no < canvasRifleArr.length; no++) {
                    var canvasRifle = canvasRifleArr[no];
                    var ctx = canvasRifle.getContext("2d");
                    // 加载前清空画布
                    ctx.clearRect(0, 0, canvasRifle.clientWidth, canvasRifle.clientHeight);
                    var w = canvasRifle.clientWidth / 2;//根据(0, 0)点横坐标需要移动的距离
                    var h = canvasRifle.clientHeight / 2;//根据(0, 0)点纵坐标需要移动的距离
                    var n = 9;//画圆数目
                    var spacing = 5;//标准比例环半径差
                    var ring_height = canvasRifle.clientHeight * 0.96;//核心区域高
                    var ring_radius = ring_height / 2;//核心区域最外圈半径

                    var rifle_ring_unit = ring_height * (0.5 / 45.5);//核心区域标准比例的最小单位长度（步枪）
                    for (var i = 0; i < n; i++) {
                        ctx.beginPath();//开始一个新的绘制路径
                        ctx.fillStyle = "transparent";//填充透明
                        ctx.arc(w, h, ring_radius - rifle_ring_unit * spacing * i, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.font = "normal bold 8px Source Han Sans CN,serif";
                        ctx.fillStyle = "#000000";
                        if (i + 1 < n) {
                            ctx.fillText((i + 1).toString(), -2.5 + w, -(ring_radius - rifle_ring_unit * spacing * i - 9) + h);//上环数
                            ctx.fillText((i + 1).toString(), -(ring_radius - rifle_ring_unit * spacing * i - 3) + w, 2.5 + h);//左环数
                            ctx.fillText((i + 1).toString(), ring_radius - rifle_ring_unit * spacing * i - 8 + w, 2.5 + h);//右环数
                            ctx.fillText((i + 1).toString(), -2.5 + w, ring_radius - rifle_ring_unit * spacing * i - 3 + h);//下环数
                        }
                        ctx.lineWidth = 2;//边框
                        ctx.strokeStyle = "black";
                        ctx.stroke();
                    }
                    // 画步枪靶圆心
                    ctx.beginPath();//开始一个新的绘制路径
                    ctx.fillStyle = "black";
                    ctx.arc(w, h, rifle_ring_unit * 0.5, 0, Math.PI * 2);
                    ctx.fill();
                }
            },
            /**
             * 绘制手枪靶
             */
            drawPistolTarget() {
                var canvasPistolArr = document.getElementsByClassName("shoot-unit-target");
                for (var no = 0; no < canvasPistolArr.length; no++) {
                    var canvasPistol = canvasPistolArr[no];
                    var ctx = canvasPistol.getContext("2d");
                    // 加载前清空画布
                    ctx.clearRect(0, 0, canvasPistol.clientWidth, canvasPistol.clientHeight);
                    var w = canvasPistol.clientWidth / 2;//根据(0, 0)点横坐标需要移动的距离
                    var h = canvasPistol.clientHeight / 2;//根据(0, 0)点纵坐标需要移动的距离
                    var n = 9;//画圆数目
                    var spacing = 16;//标准比例环半径差
                    var ring_height = canvasPistol.clientHeight * 0.96;//核心区域高
                    var ring_radius = ring_height / 2;//核心区域最外圈半径

                    var pistol_ring_unit = ring_height * (0.5 / 155.5);//核心区域标准比例的最小单位长度（手枪）
                    for (var i = 0; i < n; i++) {
                        ctx.beginPath();//开始一个新的绘制路径
                        ctx.fillStyle = "transparent";//填充透明
                        ctx.arc(w, h, ring_radius - pistol_ring_unit * spacing * i, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.font = "normal bold 8px Source Han Sans CN,serif";
                        ctx.fillStyle = "#000000";
                        if (i + 1 < n) {
                            ctx.fillText((i + 1).toString(), -3 + w, -(ring_radius - pistol_ring_unit * spacing * i - 8.5) + h);//上环数
                            ctx.fillText((i + 1).toString(), -(ring_radius - pistol_ring_unit * spacing * i - 3) + w, 3 + h);//左环数
                            ctx.fillText((i + 1).toString(), ring_radius - pistol_ring_unit * spacing * i - 8 + w, 3 + h);//右环数
                            ctx.fillText((i + 1).toString(), -3 + w, ring_radius - pistol_ring_unit * spacing * i - 2.5 + h);//下环数
                        }
                        ctx.lineWidth = 2;//边框
                        ctx.strokeStyle = "black";
                        ctx.stroke();
                    }
                    // 画手枪靶外圆心
                    ctx.beginPath();//开始一个新的绘制路径
                    ctx.fillStyle = "transparent";//填充透明
                    ctx.arc(w, h, pistol_ring_unit * 11.5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.lineWidth = 2;//边框
                    ctx.strokeStyle = "black";
                    ctx.stroke();
                    // 画手枪内圆心
                    ctx.beginPath();//开始一个新的绘制路径
                    ctx.fillStyle = "transparent";//填充透明
                    ctx.arc(w, h, pistol_ring_unit * 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.lineWidth = 2;//边框
                    ctx.strokeStyle = "black";
                    ctx.stroke();
                }
            },
            /**
             * 绘制射击点
             */
            paintPoint(no) {
                var canvasPointArr = document.getElementsByClassName("shoot-unit-point");
                var canvasPoint = canvasPointArr[no - 1];
                var ctx = canvasPoint.getContext("2d");
                // 加载前清空画布
                ctx.clearRect(0, 0, canvasPoint.clientWidth, canvasPoint.clientHeight);
                var w = canvasPoint.clientWidth / 2;//根据(0, 0)点横坐标需要移动的距离
                var h = canvasPoint.clientHeight / 2;//根据(0, 0)点纵坐标需要移动的距离
                // 定义射击点边框、半径、坐标参数
                var border;
                var radius;
                var coordinate;
                var unitShootPointArray;
                var ring_height = canvasPoint.clientHeight * 0.96;//核心区域高
                var ring_radius = ring_height / 2;//核心区域最外圈半径
                var rifle_ring_unit = ring_height * (0.5 / 45.5);//核心区域标准比例的最小单位长度（步枪）
                var pistol_ring_unit = ring_height * (0.5 / 155.5);//核心区域标准比例的最小单位长度（手枪）
                if (this.match_type === "步枪") {
                    radius = 4.5 * rifle_ring_unit;
                    unitShootPointArray = this.allLinesTargetData.find(item => item.unitTargetNo === no);
                    for (var i = 0; i < unitShootPointArray.unitShootData.length; i++) {
                        coordinate = {
                            x: (radius + ring_radius) * unitShootPointArray.unitShootData[i].unitShootPoint.x + w,
                            y: (radius + ring_radius) * unitShootPointArray.unitShootData[i].unitShootPoint.y + h
                        };
                        ctx.beginPath();
                        if (i === unitShootPointArray.unitShootData.length - 1) {
                            ctx.fillStyle = "#ff0000";
                        } else {
                            ctx.fillStyle = "#00ff00";
                        }
                        ctx.arc(coordinate.x, coordinate.y, radius, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else if (this.match_type === "手枪") {
                    radius = 4.5 * pistol_ring_unit;
                    unitShootPointArray = this.allLinesTargetData.find(item => item.unitTargetNo === no);
                    for (var j = 0; j < unitShootPointArray.unitShootData.length; j++) {
                        coordinate = {
                            x: (radius + ring_radius) * unitShootPointArray.unitShootData[j].unitShootPoint.x + w,
                            y: (radius + ring_radius) * unitShootPointArray.unitShootData[j].unitShootPoint.y + h
                        };
                        ctx.beginPath();
                        if (j === unitShootPointArray.unitShootData.length - 1) {
                            ctx.fillStyle = "#ff0000";
                        } else {
                            ctx.fillStyle = "#00ff00";
                        }
                        ctx.arc(coordinate.x, coordinate.y, radius, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            },
            /**
             * 清空射击点
             */
            cleanPoint() {
                var canvasResetArr = document.getElementsByClassName("shoot-unit-point");
                for (var i = 0; i < canvasResetArr.length; i++) {
                    var canvasReset = canvasResetArr[i];
                    var ctx = canvasReset.getContext("2d");
                    ctx.clearRect(0, 0, canvasReset.clientWidth, canvasReset.clientHeight);
                }
            },
        }
    })

    // 全局请求地址
    var globalUrl = "http://192.168.3.2:3881";

    // 全局请求方法
    function request(spliceUrl, paramData) {
        // 请求返回数据存放
        var ajaxData;
        $.ajax({
            async: false,
            url: globalUrl + spliceUrl,
            type: "get",
            dataType: "json",
            data: paramData,
            success: function (data) {
                ajaxData = data;
            }
        })
        return ajaxData.data;
    }

    // WebSocket获取数据
    // 云服务器地址
    var host = "ws://192.168.3.2:3881/refereeView/" + matchWholeInfo.venue_num * 100000;
    var lockReconnect = false;//避免重复连接
    var ws = new WebSocket(host);
    ws.onopen = function (event) {
        console.log("Connection open ...");
    };
    var onMsg = function (event) {
        eval("var obj = " + event.data);
        var info = obj;
        switch (info.type) {
            case 0://暂无赛事
                largeScreen_no_match();
                break;
            case 1://赛事信息
                //裁判获取比赛类型初始化靶以及分组靶道
                largeScreen_match_info(info.data);
                break;
            case 1003://加载一组选手信息
                //裁判获取所有靶道选手简要信息
                largeScreen_onload_player(info.data);
                break;
            case 3://开始试射
                signalTest();
                break;
            case 4://正式射击
                signalReady();
                break;
            case 5://继续射击
                signalContinueShoot();
                break;
            case 6://单发决赛
                signalOddFinals();
                break;
            case 7://比赛结束
                signalMatchEnd();
                break;
            case 8://需要单发射击
                signalNeedOddFinals();
                break;
            case 9://射击数据
                //裁判获取所有靶道各自对应射击数据
                largeScreen_shoot_data(info.data);
                break;
            case 10://排名数据
                //获取排名集合
                largeScreen_rank_info(info.data);
                break;
            case 11://缩放数据
                //获取Canvas放大缩小信号
                //zoom_info(info.data);
                break;
            case 12://选手淘汰
                largeScreen_over_info(info.data);
                break;
            case 1005://上线离线数据
                // largeScreen_target_state(info.data);
                break;
            case 1006://
                break;
            default:
                break;
        }
    };
    ws.onmessage = onMsg;
    ws.onclose = function (event) {
        console.log("Connection closed.");
        reconnect(host);
    };

    // 服务器断连重连
    function reconnect(uri) {
        matchWholeInfo.match_name = "断线重连中...";
        console.log("Connection reconnect");
        if (!lockReconnect) {
            lockReconnect = true;
            setTimeout(function () {
                ws = new WebSocket(host);
                ws.onmessage = onMsg;
                ws.onclose = function () {
                    reconnect(uri)
                };
                ws.onerror = function () {
                    reconnect(uri);
                }
                lockReconnect = false;
            }, 5000)
        }
    }

    // 处理暂无赛事
    function largeScreen_no_match() {
        matchWholeInfo.match_name = "暂无赛事信息";
    }

    // 处理比赛JSON信息
    function largeScreen_match_info(match_data) {
        eval("var obj = " + match_data);
        var info = obj;
        console.log(info);
        var competitionId = parseInt(info.competitionId);
        var group = info.currentGroup;
        var type = info.competitionEvent.toString().split("-");
        var stage = info.stage;
        matchWholeInfo.match_type = type[2];//比赛类型赋值vue
        matchWholeInfo.match_type_string = type[0] + type[1] + "激光" + type[2];//比赛类型字符串赋值vue
        matchWholeInfo.match_name = info.competitionName;//比赛名称赋值vue
        matchWholeInfo.current_group_no = group;//当前分组赋值vue
        matchWholeInfo.current_group_target_sum = info.quantityOfTarget;//当前分组存在靶道数量
        matchWholeInfo.all_groups_sum = info.quantityOfGroup;//所有分组数量
        // 当接到新的比赛信息时清空所有靶道射击数据及靶上数据
        matchWholeInfo.allLinesShootData = [];
        matchWholeInfo.allLinesTargetData = [];
        if (stage === 1) {
            matchWholeInfo.match_stage = "资格赛";//比赛阶段赋值vue
        } else if (stage === 2) {
            matchWholeInfo.match_stage = "决赛";
        }
        matchWholeInfo.match_process = "比赛即将开始";
        // 根据靶道数量生成盒子
        for (var i = 0; i < info.quantityOfTarget; i++) {
            var list1 = {
                unitTargetNo: i + 1,//靶道编号
                unitPlayerId: 0,//选手编号
                unitPlayerName: "",//选手名字
                unitPlayerTeam: "",//选手团队
                unitIsFinish: false,//默认未完成比赛
                unitCurrentScore: 0,//当前环数
                unitHeadTenShot: 0,//前十发成绩总和
                unitTotalScore: 0,//总成绩
                unitRankNum: info.quantityOfTarget + 1,//默认排名
                unitRankColor: "",//排名颜色
                unitRingDiff: 0,//默认环差
                unitShootData: []//按分组显示规则存放该靶道射击数据默认为空
            };
            matchWholeInfo.allLinesShootData.push(list1);
            var list2 = {
                unitTargetNo: i + 1,//靶道编号
                unitPlayerId: 0,//选手编号
                unitPlayerName: "",//选手名字
                unitPlayerTeam: "",//选手团队
                unitIsFinish: false,//默认未完成比赛
                unitCurrentScore: 0,//当前环数
                unitHeadTenShot: 0,//前十发成绩总和
                unitTotalScore: 0,//总成绩
                unitRankNum: info.quantityOfTarget + 1,//默认排名
                unitRankColor: "",//排名颜色
                unitRingDiff: 0,//默认环差
                unitShootData: []//按分组显示规则存放该靶道射击数据默认为空
            };
            matchWholeInfo.allLinesTargetData.push(list2);
        }
        matchWholeInfo.$nextTick(function () {
            if (matchWholeInfo.match_type === "步枪") {
                matchWholeInfo.drawRifleTarget();
            } else if (matchWholeInfo.match_type === "手枪") {
                matchWholeInfo.drawPistolTarget();
            }
        })
    }

    // 处理分组和分组内所有靶道选手信息JSON信息
    function largeScreen_onload_player(player_info) {
        eval("var obj = " + player_info);
        var info = obj;
        console.log(info);
        var unitRankList;
        var unitTargetList;
        for (var i = 0; i < info.length; i++) {
            unitRankList = matchWholeInfo.allLinesShootData.find(item => item.unitTargetNo === info[i].target);
            unitRankList.unitPlayerId = info[i].athleteId;//选手编号
            unitRankList.unitPlayerName = info[i].athleteName;//选手姓名
            unitRankList.unitPlayerTeam = info[i].team;//选手姓名
            //重置所有射击信息
            unitRankList.unitIsFinish = false;
            unitRankList.unitCurrentScore = 0;
            unitRankList.unitHeadTenShot = 0;
            unitRankList.unitTotalScore = 0;
            unitRankList.unitRankNum = matchWholeInfo.current_group_target_sum + 1;
            unitRankList.unitRankColor = "";
            unitRankList.unitRingDiff = 0;
            unitRankList.unitShootData = [];
        }
        for (var j = 0; j < info.length; j++) {
            unitTargetList = matchWholeInfo.allLinesTargetData.find(item => item.unitTargetNo === info[j].target);
            unitTargetList.unitPlayerId = info[j].athleteId;//选手编号
            unitTargetList.unitPlayerName = info[j].athleteName;//选手姓名
            unitTargetList.unitPlayerTeam = info[j].team;//选手姓名
            //重置所有射击信息
            unitTargetList.unitIsFinish = false;
            unitTargetList.unitCurrentScore = 0;
            unitTargetList.unitHeadTenShot = 0;
            unitTargetList.unitTotalScore = 0;
            unitTargetList.unitRankNum = matchWholeInfo.current_group_target_sum + 1;
            unitTargetList.unitRankColor = "";
            unitTargetList.unitRingDiff = 0;
            unitTargetList.unitShootData = [];
        }
    }

    // 处理分组内所有靶道射击数据JSON信息
    function largeScreen_shoot_data(shoot_data) {
        eval("var obj = " + shoot_data);
        var info = obj;
        console.log(info);
        var unitRankList = {};
        var unitTargetList = {};
        var detailList1 = {
            unitOrderNo: info.aim.order,//发序
            unitShootPoint: {x: info.aim.x, y: info.aim.y},//射击点坐标
            unitShootDirection: info.direction,//方位
            unitShootScore: info.score,//当前环数成绩
        };
        var detailList2 = {
            unitOrderNo: info.aim.order,//发序
            unitShootPoint: {x: info.aim.x, y: info.aim.y},//射击点坐标
            unitShootDirection: info.direction,//方位
            unitShootScore: info.score,//当前环数成绩
        };
        if (matchWholeInfo.isTestingShoot || matchWholeInfo.isOddShootingFinals) {//如果是正在进行试射或者正在进行单发射击
            if (matchWholeInfo.isOddShootingFinals) {
                unitTargetList = matchWholeInfo.allLinesTargetData.find(item => item.unitTargetNo === info.target);
                unitTargetList.unitCurrentScore = info.score;//当前环数
                unitTargetList.unitShootData = [];
                unitTargetList.unitShootData.push(detailList2);
                matchWholeInfo.paintPoint(info.target);
            } else {
                //射击数据不处理
            }
        } else {
            // 获取数据并根据靶道对应存放
            unitRankList = matchWholeInfo.allLinesShootData.find(item => item.unitTargetNo === info.target);
            unitRankList.unitCurrentScore = info.score;//当前环数
            if (info.aim.order <= 10) {
                unitRankList.unitHeadTenShot = info.totalScore;//前十发成绩
            }
            unitRankList.unitOrderCount = info.aim.order;//射击数量
            unitRankList.unitTotalScore = info.totalScore;//总成绩
            unitRankList.unitAverageScore = info.totalScore / info.aim.order;//平均成绩

            unitTargetList = matchWholeInfo.allLinesTargetData.find(item => item.unitTargetNo === info.target);
            unitTargetList.unitCurrentScore = info.score;//当前环数
            if (info.aim.order <= 10) {
                unitTargetList.unitHeadTenShot = info.totalScore;//前十发成绩
            }
            unitTargetList.unitOrderCount = info.aim.order;//射击数量
            unitTargetList.unitTotalScore = info.totalScore;//总成绩
            unitTargetList.unitAverageScore = info.totalScore / info.aim.order;//平均成绩
            if (matchWholeInfo.match_stage === "资格赛") {
            } else if (matchWholeInfo.match_stage === "决赛") {
                if (info.aim.order <= 10) {
                    if (info.aim.order % 5 === 1) {
                        unitTargetList.unitShootData = [];
                    }
                } else {
                    if (info.aim.order % 2 === 1) {
                        unitTargetList.unitShootData = [];
                    }
                }
                unitRankList.unitShootData.push(detailList1);
                unitTargetList.unitShootData.push(detailList2);
                matchWholeInfo.paintPoint(info.target);
            }
        }
    }

    // 对象数组排序方法
    function compare(property,desc) {
        return function (a, b) {
            var value1 = a[property];
            var value2 = b[property];
            if(desc === true){
                // 升序排列
                return value1 - value2;
            }else{
                // 降序排列
                return value2 - value1;
            }
        }
    }
    // 处理所有靶道排名JSON信息
    function largeScreen_rank_info(rank_data) {
        eval("var obj = " + rank_data);
        var info = obj;
        var rank;
        var unitRankList;
        var unitTargetList;
        var beforeTargetTotalScore = 0;//排名前一位靶道总成绩
        var currentTargetTotalScore = 0;//当前排名靶道总成绩
        info.forEach((value , i) => {
            for (var key in value) {
                // 根据排名顺序的靶道获取对应射击数据
                unitRankList = matchWholeInfo.allLinesShootData.find(item => item.unitTargetNo === parseInt(key.substring(2)));
                unitTargetList = matchWholeInfo.allLinesTargetData.find(item => item.unitTargetNo === parseInt(key.substring(2)));
                rank = value[key];
            }
            currentTargetTotalScore = unitRankList.unitTotalScore;
            unitRankList.unitRingDiff = beforeTargetTotalScore - currentTargetTotalScore;
            beforeTargetTotalScore = currentTargetTotalScore;
            unitRankList.unitRankNum = rank;
            unitTargetList.unitRankNum = rank;
            unitTargetList.unitRankColor = matchWholeInfo.rank_color_list[rank];
        })
        // 根据排名将数组进行升序排序
        matchWholeInfo.allLinesShootData.sort(compare("unitRankNum", true));
    }

    // 处理试射信号
    function signalTest() {
        matchWholeInfo.isTestingShoot = true;
        matchWholeInfo.match_process = "正在试射";
    }

    // 处理开始信号
    function signalReady() {
        matchWholeInfo.isTestingShoot = false;
        matchWholeInfo.match_process = "正式射击";
    }

    // 处理比赛结束信号
    function signalMatchEnd() {
        matchWholeInfo.match_process = "比赛结束";
    }

    // 处理需要进行单发射击
    function signalNeedOddFinals() {
        matchWholeInfo.match_process = "需要进行单发射击";
    }

    // 处理单发射击信号
    function signalOddFinals() {
        matchWholeInfo.match_process = "正在进行单发射击";
        matchWholeInfo.isOddShootingFinals = true;
    }

    // 处理继续射击信号
    function signalContinueShoot() {
        matchWholeInfo.match_process = "正式射击";
        matchWholeInfo.isOddShootingFinals = false;
    }

    // 处理选手淘汰信号
    function largeScreen_over_info(over_data) {
        eval("var obj = " + over_data);
        var info = obj;
        console.log(info);
        var unitRankList = matchWholeInfo.allLinesShootData.find(item => item.unitTargetNo === info.target);
        if (unitRankList !== undefined) {
            if (info.status === true) {
                unitRankList.unitIsFinish = true;
            }
        }
        var unitTargetList = matchWholeInfo.allLinesTargetData.find(item => item.unitTargetNo === info.target);
        if (unitTargetList !== undefined) {
            if (info.status === true) {
                unitTargetList.unitIsFinish = true;
            }
        }
    }
</script>
</html>